<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>bes: RemoteResource.cc Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">bes
   &#160;<span id="projectnumber">Updated for version 3.20.8-314</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('dc/da3/RemoteResource_8cc_source.html','../../');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">RemoteResource.cc</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">// -*- mode: c++; c-basic-offset:4 -*-</span></div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">// This file is part of the BES http package, part of the Hyrax data server.</span></div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">// Copyright (c) 2020 OPeNDAP, Inc.</span></div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">// Author: Nathan Potter &lt;ndp@opendap.org&gt;</span></div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">//</span></div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">// This library is free software; you can redistribute it and/or</span></div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">// modify it under the terms of the GNU Lesser General Public</span></div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">// License as published by the Free Software Foundation; either</span></div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">// version 2.1 of the License, or (at your option) any later version.</span></div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">//</span></div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">// This library is distributed in the hope that it will be useful,</span></div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment">// but WITHOUT ANY WARRANTY; without even the implied warranty of</span></div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span></div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment">// Lesser General Public License for more details.</span></div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment">//</span></div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment">// You should have received a copy of the GNU Lesser General Public</span></div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment">// License along with this library; if not, write to the Free Software</span></div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment">// Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA</span></div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="comment">//</span></div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="comment">// You can contact OPeNDAP, Inc. at PO Box 112, Saunderstown, RI. 02874-0112.</span></div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="comment">// Authors:</span></div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="comment">//      ndp       Nathan Potter &lt;ndp@opendap.org&gt;</span></div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="preprocessor">#include &quot;config.h&quot;</span></div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="preprocessor">#include &lt;sstream&gt;</span></div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="preprocessor">#include &lt;fstream&gt;</span></div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="preprocessor">#include &lt;string&gt;</span></div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="preprocessor">#include &lt;iostream&gt;</span></div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="preprocessor">#include &lt;sys/stat.h&gt;</span></div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../db/df5/document_8h.html">rapidjson/document.h</a>&quot;</span></div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="preprocessor">#include &quot;BESInternalError.h&quot;</span></div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="preprocessor">#include &quot;BESForbiddenError.h&quot;</span></div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="preprocessor">#include &quot;BESSyntaxUserError.h&quot;</span></div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="preprocessor">#include &quot;BESNotFoundError.h&quot;</span></div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="preprocessor">#include &quot;BESTimeoutError.h&quot;</span></div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="preprocessor">#include &quot;BESDebug.h&quot;</span></div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="preprocessor">#include &quot;BESUtil.h&quot;</span></div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="preprocessor">#include &quot;HttpCache.h&quot;</span></div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="preprocessor">#include &quot;HttpUtils.h&quot;</span></div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="preprocessor">#include &quot;CurlUtils.h&quot;</span></div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="preprocessor">#include &quot;HttpNames.h&quot;</span></div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="preprocessor">#include &quot;RemoteResource.h&quot;</span></div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="preprocessor">#include &quot;TheBESKeys.h&quot;</span></div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="preprocessor">#include &quot;BESStopWatch.h&quot;</span></div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="preprocessor">#include &quot;BESLog.h&quot;</span></div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;<span class="keyword">using namespace </span><a class="code" href="../../d8/dcc/namespacestd.html">std</a>;</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;<span class="preprocessor">#define BES_CATALOG_ROOT_KEY &quot;BES.Catalog.catalog.RootDirectory&quot;</span></div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<span class="preprocessor">#define prolog std::string(&quot;RemoteResource::&quot;).append(__func__).append(&quot;() - &quot;)</span></div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;<span class="preprocessor">#define MODULE &quot;rr&quot;</span></div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;<span class="keyword">namespace </span><a class="code" href="../../d3/d69/namespacehttp.html">http</a> {</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;    RemoteResource::RemoteResource(<span class="keyword">const</span> std::string &amp;url,<span class="keyword">const</span> std::string &amp;uid, <span class="keywordtype">long</span> <span class="keywordtype">long</span> expiredInterval){</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;        d_fd = 0;</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;        d_initialized = <span class="keyword">false</span>;</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;        d_uid = uid;</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;        d_resourceCacheFileName.clear();</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;        d_response_headers = <span class="keyword">new</span> vector&lt;string&gt;();</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;        d_http_response_headers = <span class="keyword">new</span> map&lt;string, string&gt;();</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;        d_expires_interval = expiredInterval;</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;        <span class="keywordflow">if</span> (url.empty()) {</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;            <span class="keywordflow">throw</span> <a class="code" href="../../d9/d82/classBESInternalError.html">BESInternalError</a>(prolog + <span class="stringliteral">&quot;Remote resource URL is empty.&quot;</span>, __FILE__, __LINE__);</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;        }</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;        <span class="keywordflow">if</span>(url.find(FILE_PROTOCOL) == 0){</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;            d_resourceCacheFileName = url.substr(strlen(FILE_PROTOCOL));</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;            <span class="keywordflow">while</span>(<a class="code" href="../../d8/d4c/classBESUtil.html#a2576ba5d2f9e4ad4fa6d413fe9785d27">BESUtil::endsWith</a>(d_resourceCacheFileName,<span class="stringliteral">&quot;/&quot;</span>)){</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;                <span class="comment">// Strip trailing slashes, because this about files, not directories</span></div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;                d_resourceCacheFileName = d_resourceCacheFileName.substr(0,d_resourceCacheFileName.length()-1);</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;            }</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;            <span class="comment">// Now we check that the data is in the BES_CATALOG_ROOT</span></div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;            <span class="keywordtype">string</span> catalog_root;</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;            <span class="keywordtype">bool</span> found;</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;            <a class="code" href="../../d5/d64/classTheBESKeys.html#a2434be88f175d43ee8a6dd69754496a6">TheBESKeys::TheKeys</a>()-&gt;<a class="code" href="../../d5/d64/classTheBESKeys.html#a18b1aa0f0cee5dd5cf787a14fd1e8951">get_value</a>(BES_CATALOG_ROOT_KEY,catalog_root,found );</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;            <span class="keywordflow">if</span>(!found){</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;                <span class="keywordflow">throw</span> <a class="code" href="../../d9/d82/classBESInternalError.html">BESInternalError</a>( prolog + <span class="stringliteral">&quot;ERROR - &quot;</span>+ BES_CATALOG_ROOT_KEY + <span class="stringliteral">&quot;is not set&quot;</span>,__FILE__,__LINE__);</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;            }</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;            <span class="keywordflow">if</span>(d_resourceCacheFileName.find(catalog_root) !=0 ){</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;                d_resourceCacheFileName = <a class="code" href="../../d8/d4c/classBESUtil.html#a6fe40e13784e613b86c7cc13dfafbda0">BESUtil::pathConcat</a>(catalog_root,d_resourceCacheFileName);</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;            }</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;            d_initialized =<span class="keyword">true</span>;</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;        }</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(url.find(HTTPS_PROTOCOL) == 0  || url.find(HTTP_PROTOCOL) == 0){</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;            d_remoteResourceUrl = url;</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;            BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot;URL: &quot;</span> &lt;&lt; d_remoteResourceUrl &lt;&lt; endl);</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;<span class="preprocessor">#if 0</span></div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;            <span class="keywordflow">if</span> (!d_uid.empty()){</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;                <span class="keywordtype">string</span> client_id_hdr = <span class="stringliteral">&quot;User-Id: &quot;</span> + d_uid;</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;                BESDEBUG(MODULE, prolog &lt;&lt; client_id_hdr &lt;&lt; endl);</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;                d_request_headers.push_back(client_id_hdr);</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;            }</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;            <span class="keywordflow">if</span> (!d_echo_token.empty()){</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;                <span class="keywordtype">string</span> echo_token_hdr = <span class="stringliteral">&quot;Echo-Token: &quot;</span> + d_echo_token;</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;                BESDEBUG(MODULE, prolog &lt;&lt; echo_token_hdr &lt;&lt; endl);</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;                d_request_headers.push_back(echo_token_hdr);</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;            }</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;        }</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;        <span class="keywordflow">else</span> {</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;            <span class="keywordtype">string</span> err = prolog + <span class="stringliteral">&quot;Unsupported protocol: &quot;</span> + url;</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;            <span class="keywordflow">throw</span> <a class="code" href="../../d9/d82/classBESInternalError.html">BESInternalError</a>(err, __FILE__, __LINE__);</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;        }</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;        <span class="comment">// BESDEBUG(MODULE, prolog &lt;&lt; &quot;d_curl: &quot; &lt;&lt; d_curl &lt;&lt; endl);</span></div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;    }</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;<span class="preprocessor">#if 0</span></div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;    RemoteResource::RemoteResource(<span class="keyword">const</span> std::string &amp;url, <span class="keyword">const</span> std::string &amp;uid, <span class="keyword">const</span> std::string &amp;echo_token) {</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;        d_fd = 0;</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;        d_initialized = <span class="keyword">false</span>;</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;        d_uid = uid;</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;        d_echo_token = echo_token;</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;        <span class="comment">// d_curl = curl::init(url);</span></div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;        d_resourceCacheFileName.clear();</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;        d_response_headers = <span class="keyword">new</span> vector&lt;string&gt;();</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;        d_request_headers = <span class="keyword">new</span> vector&lt;string&gt;();</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;        d_http_response_headers = <span class="keyword">new</span> map&lt;string, string&gt;();</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;        <span class="keywordflow">if</span> (url.empty()) {</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;            <span class="keywordflow">throw</span> <a class="code" href="../../d9/d82/classBESInternalError.html">BESInternalError</a>(prolog + <span class="stringliteral">&quot;Remote resource URL is empty.&quot;</span>, __FILE__, __LINE__);</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;        }</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;        <span class="keywordflow">if</span>(url.find(FILE_PROTOCOL) == 0){</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;            d_resourceCacheFileName = url.substr(strlen(FILE_PROTOCOL));</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;            <span class="keywordflow">while</span>(<a class="code" href="../../d8/d4c/classBESUtil.html#a2576ba5d2f9e4ad4fa6d413fe9785d27">BESUtil::endsWith</a>(d_resourceCacheFileName,<span class="stringliteral">&quot;/&quot;</span>)){</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;                <span class="comment">// Strip trailing slashes, because this about files, not directories</span></div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;                d_resourceCacheFileName = d_resourceCacheFileName.substr(0,d_resourceCacheFileName.length()-1);</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;            }</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;            <span class="comment">// Now we check that the data is in the BES_CATALOG_ROOT</span></div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;            <span class="keywordtype">string</span> catalog_root;</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;            <span class="keywordtype">bool</span> found;</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;            <a class="code" href="../../d5/d64/classTheBESKeys.html#a2434be88f175d43ee8a6dd69754496a6">TheBESKeys::TheKeys</a>()-&gt;<a class="code" href="../../d5/d64/classTheBESKeys.html#a18b1aa0f0cee5dd5cf787a14fd1e8951">get_value</a>(BES_CATALOG_ROOT_KEY,catalog_root,found );</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;            <span class="keywordflow">if</span>(!found){</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;                <span class="keywordflow">throw</span> <a class="code" href="../../d9/d82/classBESInternalError.html">BESInternalError</a>( prolog + <span class="stringliteral">&quot;ERROR - &quot;</span>+ BES_CATALOG_ROOT_KEY + <span class="stringliteral">&quot;is not set&quot;</span>,__FILE__,__LINE__);</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;            }</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;            <span class="keywordflow">if</span>(d_resourceCacheFileName.find(catalog_root) !=0 ){</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;                d_resourceCacheFileName = <a class="code" href="../../d8/d4c/classBESUtil.html#a6fe40e13784e613b86c7cc13dfafbda0">BESUtil::pathConcat</a>(catalog_root,d_resourceCacheFileName);</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;            }</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;            d_initialized =<span class="keyword">true</span>;</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;        }</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(url.find(HTTPS_PROTOCOL) == 0  || url.find(HTTP_PROTOCOL) == 0){</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;            d_remoteResourceUrl = url;</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;            BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot;URL: &quot;</span> &lt;&lt; d_remoteResourceUrl &lt;&lt; endl);</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;            <span class="keywordflow">if</span> (!d_uid.empty()){</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;                <span class="keywordtype">string</span> client_id_hdr = <span class="stringliteral">&quot;User-Id: &quot;</span> + d_uid;</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;                BESDEBUG(MODULE, prolog &lt;&lt; client_id_hdr &lt;&lt; endl);</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;                d_request_headers-&gt;push_back(client_id_hdr);</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;            }</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;            <span class="keywordflow">if</span> (!d_echo_token.empty()){</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;                <span class="keywordtype">string</span> echo_token_hdr = <span class="stringliteral">&quot;Echo-Token: &quot;</span> + d_echo_token;</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;                BESDEBUG(MODULE, prolog &lt;&lt; echo_token_hdr &lt;&lt; endl);</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;                d_request_headers-&gt;push_back(echo_token_hdr);</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;            }</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;        }</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;        <span class="keywordflow">else</span> {</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;            <span class="keywordtype">string</span> err = prolog + <span class="stringliteral">&quot;Unsupported protocol: &quot;</span> + url;</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;            <span class="keywordflow">throw</span> <a class="code" href="../../d9/d82/classBESInternalError.html">BESInternalError</a>(err, __FILE__, __LINE__);</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;        }</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;        <span class="comment">// BESDEBUG(MODULE, prolog &lt;&lt; &quot;d_curl: &quot; &lt;&lt; d_curl &lt;&lt; endl);</span></div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;    }</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;</div><div class="line"><a name="l00201"></a><span class="lineno"><a class="line" href="../../dd/d98/classhttp_1_1RemoteResource.html#a9ad66dcd7430b4b67ad6a4f0afc68c9e">  201</a></span>&#160;    RemoteResource::~RemoteResource() {</div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;        BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot;BEGIN resourceURL: &quot;</span> &lt;&lt; d_remoteResourceUrl &lt;&lt; endl);</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;        <span class="keyword">delete</span> d_response_headers;</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;        d_response_headers = 0;</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;        BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot;Deleted d_response_headers.&quot;</span> &lt;&lt; endl);</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;        <span class="keywordflow">if</span> (!d_resourceCacheFileName.empty()) {</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;            <a class="code" href="../../d1/d11/classhttp_1_1HttpCache.html">HttpCache</a> *cache = HttpCache::get_instance();</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;            <span class="keywordflow">if</span> (cache) {</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;                cache-&gt;<a class="code" href="../../dd/d75/classBESFileLockingCache.html#a5777955384b133127a2518f44ea28444">unlock_and_close</a>(d_resourceCacheFileName);</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;                BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot;Closed and unlocked &quot;</span> &lt;&lt; d_resourceCacheFileName &lt;&lt; endl);</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;                d_resourceCacheFileName.clear();</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;            }</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;        }</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;</div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;<span class="preprocessor">#if 0</span></div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;        <span class="keywordflow">if</span> (d_curl) {</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;            curl_easy_cleanup(d_curl);</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;            BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot;Called curl_easy_cleanup().&quot;</span> &lt;&lt; endl);</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;        }</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;        d_curl = 0;</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;        BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot;Clearing resourceURL: &quot;</span> &lt;&lt; d_remoteResourceUrl &lt;&lt; endl);</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;        d_remoteResourceUrl.clear();</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;        BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot;END&quot;</span> &lt;&lt; endl);</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;    }</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;</div><div class="line"><a name="l00234"></a><span class="lineno"><a class="line" href="../../dd/d98/classhttp_1_1RemoteResource.html#a1262e35b588f91f9124579551f87551b">  234</a></span>&#160;    std::string RemoteResource::getCacheFileName() {</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;        <span class="keywordflow">if</span> (!d_initialized) {</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;            <span class="keywordflow">throw</span> <a class="code" href="../../d9/d82/classBESInternalError.html">BESInternalError</a>(prolog + <span class="stringliteral">&quot;STATE ERROR: Remote Resource &quot;</span> + d_remoteResourceUrl +</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;                                   <span class="stringliteral">&quot; has Not Been Retrieved.&quot;</span>, __FILE__, __LINE__);</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;        }</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;        <span class="keywordflow">return</span> d_resourceCacheFileName;</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;    }</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;</div><div class="line"><a name="l00249"></a><span class="lineno"><a class="line" href="../../dd/d98/classhttp_1_1RemoteResource.html#a2c48635d87266eec70822c67655f4a98">  249</a></span>&#160;    <span class="keywordtype">void</span> RemoteResource::retrieveResource() {</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;        std::map&lt;std::string, std::string&gt; content_filters;</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;        retrieveResource(content_filters);</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;    }</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;</div><div class="line"><a name="l00265"></a><span class="lineno"><a class="line" href="../../dd/d98/classhttp_1_1RemoteResource.html#ae8c91922bc355978fd54c49bc113e58d">  265</a></span>&#160;    <span class="keywordtype">void</span> RemoteResource::retrieveResource(<span class="keyword">const</span> std::map&lt;std::string, std::string&gt; &amp;content_filters) {</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;        BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot;BEGIN   resourceURL: &quot;</span> &lt;&lt; d_remoteResourceUrl &lt;&lt; endl);</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;        <span class="keywordtype">bool</span> mangle = <span class="keyword">true</span>;</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;        <span class="keywordflow">if</span> (d_initialized) {</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;            BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot;END  Already initialized.&quot;</span> &lt;&lt; endl);</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;            <span class="keywordflow">return</span>;</div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;        }</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;        <span class="comment">// Get a pointer to the singleton cache instance for this process.</span></div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;        <a class="code" href="../../d1/d11/classhttp_1_1HttpCache.html">HttpCache</a> *cache = HttpCache::get_instance();</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;        <span class="keywordflow">if</span> (!cache) {</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;            ostringstream oss;</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;            oss &lt;&lt; prolog &lt;&lt; <span class="stringliteral">&quot;FAILED to get local cache. &quot;</span>;</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;            oss &lt;&lt; <span class="stringliteral">&quot;Unable to proceed with request for &quot;</span> &lt;&lt; this-&gt;d_remoteResourceUrl;</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;            oss &lt;&lt; <span class="stringliteral">&quot; The server MUST have a valid HTTP cache configuration to operate.&quot;</span> &lt;&lt; endl;</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;            BESDEBUG(MODULE, oss.str());</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;            <span class="keywordflow">throw</span> <a class="code" href="../../d9/d82/classBESInternalError.html">BESInternalError</a>(oss.str(), __FILE__, __LINE__);</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;        }</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;        <span class="comment">// Get the name of the file in the cache (either the code finds this file or</span></div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;        <span class="comment">// or it makes it).</span></div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;        d_resourceCacheFileName = cache-&gt;<a class="code" href="../../d1/d11/classhttp_1_1HttpCache.html#a20f68e852206c0ac0c0c9c2802f5bf53">get_cache_file_name</a>(d_uid, d_remoteResourceUrl, mangle);</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;        BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot;d_resourceCacheFileName: &quot;</span> &lt;&lt; d_resourceCacheFileName &lt;&lt; endl);</div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;</div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;        <span class="comment">// @TODO MAKE THIS RETRIEVE THE CACHED DATA TYPE IF THE CACHED RESPONSE IF FOUND</span></div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;        <span class="comment">//   We need to know the type of the resource. HTTP headers are the preferred  way to determine the type.</span></div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;        <span class="comment">//   Unfortunately, the current code losses both the HTTP headers sent from the request and the derived type</span></div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;        <span class="comment">//   to subsequent accesses of the cached object. Since we have to have a type, for now we just set the type</span></div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;        <span class="comment">//   from the url. If down below we DO an HTTP GET then the headers will be evaluated and the type set by setType()</span></div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;        <span class="comment">//   But really - we gotta fix this.</span></div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;        http::get_type_from_url(d_remoteResourceUrl, d_type);</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;        BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot;d_type: &quot;</span> &lt;&lt; d_type &lt;&lt; endl);</div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;        <span class="keywordflow">try</span> {</div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;            <span class="keywordflow">if</span> (cache-&gt;get_exclusive_lock(d_resourceCacheFileName, d_fd)) {</div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;                BESDEBUG(MODULE,</div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;                         prolog &lt;&lt; <span class="stringliteral">&quot;Remote resource is already in cache. cache_file_name: &quot;</span> &lt;&lt; d_resourceCacheFileName</div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;                                &lt;&lt; endl);</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;                <span class="keywordflow">if</span> (is_cached_resource_expired(d_resourceCacheFileName, d_uid)) {</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;                    BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot;EXISTS - UPDATING &quot;</span> &lt;&lt; endl);</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;                    update_file_and_headers(content_filters);</div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;                    cache-&gt;<a class="code" href="../../dd/d75/classBESFileLockingCache.html#aa75f998ba8f95f88ba25624ff300f3ec">exclusive_to_shared_lock</a>(d_fd);</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;                } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;                    BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot;EXISTS - LOADING &quot;</span> &lt;&lt; endl);</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;                    cache-&gt;<a class="code" href="../../dd/d75/classBESFileLockingCache.html#aa75f998ba8f95f88ba25624ff300f3ec">exclusive_to_shared_lock</a>(d_fd);</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;                    load_hdrs_from_file();</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;                }</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;                d_initialized = <span class="keyword">true</span>;</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;                <span class="keywordflow">return</span>;</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;                <span class="comment">// Now we actually need to reach out across the interwebs and retrieve the remote resource and put it&#39;s</span></div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;                <span class="comment">// content into a local cache file, given that it&#39;s not in the cache.</span></div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;                <span class="comment">// First make an empty file and get an exclusive lock on it.</span></div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;                <span class="keywordflow">if</span> (cache-&gt;<a class="code" href="../../dd/d75/classBESFileLockingCache.html#a9e12d93d7fe5f5f03190f92362773050">create_and_lock</a>(d_resourceCacheFileName, d_fd)) {</div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;                    BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot;DOESN&#39;T EXIST - CREATING &quot;</span> &lt;&lt; endl);</div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;                    update_file_and_headers(content_filters);</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;                } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;                    BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot; WAS CREATED - LOADING &quot;</span> &lt;&lt; endl);</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;                    cache-&gt;<a class="code" href="../../dd/d75/classBESFileLockingCache.html#aa9ae66ea9b3931933f3f4e02562a8d04">get_read_lock</a>(d_resourceCacheFileName, d_fd);</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;                    load_hdrs_from_file();</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;                }</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;                d_initialized = <span class="keyword">true</span>;</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;                <span class="keywordflow">return</span>;</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;            }</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;            <span class="keywordtype">string</span> msg = prolog + <span class="stringliteral">&quot;Failed to acquire cache read lock for remote resource: &#39;&quot;</span>;</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;            msg += d_remoteResourceUrl + <span class="stringliteral">&quot;\n&quot;</span>;</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;            <span class="keywordflow">throw</span> <a class="code" href="../../d9/d82/classBESInternalError.html">BESInternalError</a>(msg, __FILE__, __LINE__);</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;        }</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;        <span class="keywordflow">catch</span> (<a class="code" href="../../d7/dbd/classBESError.html">BESError</a> &amp;besError) {</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;            BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot;Caught BESError. type: &quot;</span> &lt;&lt; besError.<a class="code" href="../../d7/dbd/classBESError.html#a9c2743b847d8d3339d894aef27c4db16">get_bes_error_type</a>() &lt;&lt;</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;            <span class="stringliteral">&quot; message: &#39;&quot;</span> &lt;&lt; besError.<a class="code" href="../../d7/dbd/classBESError.html#ab89722014819ca821667f4feb0f4eda0">get_message</a>() &lt;&lt;</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;            <span class="stringliteral">&quot;&#39; file: &quot;</span> &lt;&lt; besError.<a class="code" href="../../d7/dbd/classBESError.html#ab6f11913d45356a6ad65aac7eefe720d">get_file</a>() &lt;&lt; <span class="stringliteral">&quot; line: &quot;</span> &lt;&lt; besError.<a class="code" href="../../d7/dbd/classBESError.html#aa078d566600c190d1ec900292f24dd87">get_line</a>() &lt;&lt;</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;            <span class="stringliteral">&quot; Will unlock cache and re-throw.&quot;</span> &lt;&lt; endl);</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;            cache-&gt;<a class="code" href="../../dd/d75/classBESFileLockingCache.html#a1a70fdaa70577bd545eb842015bb85b8">unlock_cache</a>();</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;            <span class="keywordflow">throw</span>;</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;        }</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;        <span class="keywordflow">catch</span> (...) {</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;            BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot;Caught unknown exception. Will unlock cache and re-throw.&quot;</span> &lt;&lt; endl);</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;            cache-&gt;<a class="code" href="../../dd/d75/classBESFileLockingCache.html#a1a70fdaa70577bd545eb842015bb85b8">unlock_cache</a>();</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;            <span class="keywordflow">throw</span>;</div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;        }</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;</div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;    } <span class="comment">//end RemoteResource::retrieveResource()</span></div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;    <span class="keywordtype">void</span> RemoteResource::update_file_and_headers(){</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;        std::map&lt;std::string, std::string&gt; content_filters;</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;        update_file_and_headers(content_filters);</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;    }</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;    <span class="keywordtype">void</span> RemoteResource::update_file_and_headers(<span class="keyword">const</span> std::map&lt;std::string, std::string&gt; &amp;content_filters){</div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;</div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;        <span class="comment">// Get a pointer to the singleton cache instance for this process.</span></div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;        <a class="code" href="../../d1/d11/classhttp_1_1HttpCache.html">HttpCache</a> *cache = HttpCache::get_instance();</div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;        <span class="keywordflow">if</span> (!cache) {</div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;            ostringstream oss;</div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;            oss &lt;&lt; prolog &lt;&lt; <span class="stringliteral">&quot;FAILED to get local cache. &quot;</span>;</div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;            oss &lt;&lt; <span class="stringliteral">&quot;Unable to proceed with request for &quot;</span> &lt;&lt; this-&gt;d_remoteResourceUrl;</div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;            oss &lt;&lt; <span class="stringliteral">&quot; The server MUST have a valid HTTP cache configuration to operate.&quot;</span> &lt;&lt; endl;</div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;            BESDEBUG(MODULE, oss.str());</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;            <span class="keywordflow">throw</span> <a class="code" href="../../d9/d82/classBESInternalError.html">BESInternalError</a>(oss.str(), __FILE__, __LINE__);</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;        }</div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;        <span class="comment">// Write the remote resource to the cache file.</span></div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;        <span class="keywordflow">try</span> {</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;            writeResourceToFile(d_fd);</div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;        }</div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;        <span class="keywordflow">catch</span> (...) {</div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;            <span class="comment">// If things went south then we need to dump the file because we&#39;ll end up with an empty/bogus file clogging the cache</span></div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;            unlink(d_resourceCacheFileName.c_str());</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;            <span class="keywordflow">throw</span>;</div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;        }</div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;</div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;        <span class="comment">//  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -</span></div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;        <span class="comment">// Filter the response file - If content_filters map is empty then nothing is done.</span></div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;        filter_retrieved_resource(content_filters);</div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;</div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;        <span class="comment">// Write the headers to the appropriate cache file.</span></div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;        <span class="keywordtype">string</span> hdr_filename = d_resourceCacheFileName + <span class="stringliteral">&quot;.hdrs&quot;</span>;</div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;        std::ofstream hdr_out(hdr_filename.c_str());</div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;        <span class="keywordflow">try</span> {</div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; this-&gt;d_response_headers-&gt;size(); i++) {</div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;                hdr_out &lt;&lt; (*d_response_headers)[i] &lt;&lt; endl;</div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;            }</div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;        }</div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;        <span class="keywordflow">catch</span> (...) {</div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;            <span class="comment">// If this fails for any reason we:</span></div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;            hdr_out.close(); <span class="comment">// Close the stream</span></div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;            unlink(hdr_filename.c_str()); <span class="comment">// unlink the file</span></div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;            unlink(d_resourceCacheFileName.c_str()); <span class="comment">// unlink the primary cache file.</span></div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;            <span class="keywordflow">throw</span>;</div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;        }</div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;</div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;        <span class="comment">// #########################################################################################################</span></div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;</div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;        <span class="comment">// Change the exclusive lock on the new file to a shared lock. This keeps</span></div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;        <span class="comment">// other processes from purging the new file and ensures that the reading</span></div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;        <span class="comment">// process can use it.</span></div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;        cache-&gt;<a class="code" href="../../dd/d75/classBESFileLockingCache.html#aa75f998ba8f95f88ba25624ff300f3ec">exclusive_to_shared_lock</a>(d_fd);</div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;        BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot;Converted exclusive cache lock to shared lock.&quot;</span> &lt;&lt; endl);</div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;        <span class="comment">// Now update the total cache size info and purge if needed. The new file&#39;s</span></div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;        <span class="comment">// name is passed into the purge method because this process cannot detect its</span></div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;        <span class="comment">// own lock on the file.</span></div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;        <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> size = cache-&gt;<a class="code" href="../../dd/d75/classBESFileLockingCache.html#a5bf293b1c39103e9d6d0fcb88edabe6a">update_cache_info</a>(d_resourceCacheFileName);</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;        BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot;Updated cache info&quot;</span> &lt;&lt; endl);</div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;</div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;        <span class="keywordflow">if</span> (cache-&gt;<a class="code" href="../../dd/d75/classBESFileLockingCache.html#a441ebd5ab55997464c99acdb68c5b8d2">cache_too_big</a>(size)) {</div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;            cache-&gt;<a class="code" href="../../dd/d75/classBESFileLockingCache.html#afd7797d9ecb3d4daf0efc9e4ca0a36ce">update_and_purge</a>(d_resourceCacheFileName);</div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;            BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot;Updated and purged cache.&quot;</span> &lt;&lt; endl);</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;        }</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;        BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot;END&quot;</span> &lt;&lt; endl);</div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;</div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;    } <span class="comment">//end RemoteResource::update_file_and_headers()</span></div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;</div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;    <span class="keywordtype">void</span> RemoteResource::load_hdrs_from_file(){</div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;        <span class="keywordtype">string</span> hdr_filename = d_resourceCacheFileName + <span class="stringliteral">&quot;.hdrs&quot;</span>;</div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;        std::ifstream hdr_ifs(hdr_filename.c_str());</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;</div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;        <span class="keywordflow">if</span>(!hdr_ifs.is_open()){</div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;            stringstream msg;</div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;            msg &lt;&lt; <span class="stringliteral">&quot;ERROR. Internal state error. The headers file: &quot;</span> &lt;&lt; hdr_filename &lt;&lt; <span class="stringliteral">&quot; could not be opened for reading.&quot;</span>;</div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;            BESDEBUG(MODULE, prolog &lt;&lt; msg.str() &lt;&lt; endl);</div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;            <span class="keywordflow">throw</span> <a class="code" href="../../d9/d82/classBESInternalError.html">BESInternalError</a>(msg.str(), __FILE__, __LINE__);</div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;        }</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;</div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;        BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot;Reading response headers from: &quot;</span> &lt;&lt; hdr_filename &lt;&lt; endl);</div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;        <span class="keywordflow">for</span> (std::string line; std::getline(hdr_ifs, line);) {</div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;            (*d_response_headers).push_back(line);</div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;            BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot;header:   &quot;</span> &lt;&lt; line &lt;&lt; endl);</div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;        }</div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;        ingest_http_headers_and_type();</div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;    } <span class="comment">//end RemoteResource::load_hdrs_from_file()</span></div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;</div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;    <span class="keywordtype">bool</span> RemoteResource::is_cached_resource_expired(<span class="keyword">const</span> std::string &amp;filename, <span class="keyword">const</span> std::string &amp;uid){</div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;        BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot;BEGIN&quot;</span> &lt;&lt; endl);</div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;</div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;        <span class="keyword">struct </span>stat statbuf;</div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;        <span class="keywordflow">if</span> (stat(filename.c_str(), &amp;statbuf) == -1){</div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;            <span class="keywordflow">throw</span> <a class="code" href="../../dc/d1a/classBESNotFoundError.html">BESNotFoundError</a>(strerror(errno), __FILE__, __LINE__);</div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;        }<span class="comment">//end if</span></div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;        BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot;File exists&quot;</span> &lt;&lt; endl);</div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;</div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;        time_t cacheTime = statbuf.st_ctime;</div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;        BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot;Cache file creation time: &quot;</span> &lt;&lt; cacheTime &lt;&lt; endl);</div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;        time_t nowTime = time(0);</div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;        BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot;Time now: &quot;</span> &lt;&lt; nowTime &lt;&lt; endl);</div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;        <span class="keywordtype">double</span> diffSeconds = difftime(nowTime,cacheTime);</div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;        BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot;Time difference between cacheTime and nowTime: &quot;</span> &lt;&lt; diffSeconds &lt;&lt; endl);</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;</div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;        <span class="keywordflow">if</span> (diffSeconds &gt; d_expires_interval){</div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;            BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot; refresh = TRUE &quot;</span> &lt;&lt; endl);</div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;        }</div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;        <span class="keywordflow">else</span>{</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;            BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot; refresh = FALSE &quot;</span> &lt;&lt; endl);</div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;        }</div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;    } <span class="comment">//end RemoteResource::is_cache_resource_expired()</span></div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;</div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;    <span class="keywordtype">void</span> RemoteResource::writeResourceToFile(<span class="keywordtype">int</span> fd) {</div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;</div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;        BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot;BEGIN&quot;</span> &lt;&lt; endl);</div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;        <span class="keywordflow">try</span> {</div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;</div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;            <a class="code" href="../../dd/d47/classBESStopWatch.html">BESStopWatch</a> besTimer;</div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="../../d1/ded/classBESDebug.html#a82246dd035105f7af39a296ddcc51bab">BESDebug::IsSet</a>(<span class="stringliteral">&quot;rr&quot;</span>) || <a class="code" href="../../d1/ded/classBESDebug.html#a82246dd035105f7af39a296ddcc51bab">BESDebug::IsSet</a>(MODULE) || <a class="code" href="../../d1/ded/classBESDebug.html#a82246dd035105f7af39a296ddcc51bab">BESDebug::IsSet</a>(TIMING_LOG_KEY) || BESLog::TheLog()-&gt;is_verbose()){</div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;                besTimer.<a class="code" href="../../dd/d47/classBESStopWatch.html#a9d693f705d403a80937475820fef7e76">start</a>(prolog + <span class="stringliteral">&quot;source url: &quot;</span> + d_remoteResourceUrl);</div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;            }</div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;</div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;            BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot;Saving resource &quot;</span> &lt;&lt; d_remoteResourceUrl &lt;&lt; <span class="stringliteral">&quot; to cache file &quot;</span> &lt;&lt; d_resourceCacheFileName &lt;&lt; endl);</div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;            curl::http_get_and_write_resource(d_remoteResourceUrl, fd, d_response_headers); <span class="comment">// Throws BESInternalError if there is a curl error.</span></div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;</div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;            BESDEBUG(MODULE,  prolog &lt;&lt; <span class="stringliteral">&quot;Resource &quot;</span> &lt;&lt; d_remoteResourceUrl &lt;&lt; <span class="stringliteral">&quot; saved to cache file &quot;</span> &lt;&lt; d_resourceCacheFileName &lt;&lt; endl);</div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;</div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;            <span class="comment">// rewind the file</span></div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;            <span class="comment">// FIXME I think the idea here is that we have the file open and we should just keep</span></div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;            <span class="comment">// reading from it. But the container mechanism works with file names, so we will</span></div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;            <span class="comment">// likely have to open the file again. If that&#39;s true, lets remove this call. jhrg 3.2.18</span></div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;            <span class="keywordtype">int</span> status = lseek(fd, 0, SEEK_SET);</div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;            <span class="keywordflow">if</span> (-1 == status)</div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;                <span class="keywordflow">throw</span> <a class="code" href="../../d7/dbd/classBESError.html">BESError</a>(<span class="stringliteral">&quot;Could not seek within the response.&quot;</span>, BES_NOT_FOUND_ERROR, __FILE__, __LINE__);</div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;            BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot;Reset file descriptor.&quot;</span> &lt;&lt; endl);</div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;</div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;            <span class="comment">// @TODO CACHE THE DATA TYPE OR THE HTTP HEADERS SO WHEN WE ARE RETRIEVING THE CACHED OBJECT WE CAN GET THE CORRECT TYPE</span></div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;            ingest_http_headers_and_type();</div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;        }</div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;        <span class="keywordflow">catch</span> (<a class="code" href="../../d7/dbd/classBESError.html">BESError</a> &amp;e) {</div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;            <span class="keywordflow">throw</span>;</div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;        }</div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;        BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot;END&quot;</span> &lt;&lt; endl);</div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;    }</div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;</div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;    <span class="keywordtype">void</span> RemoteResource::ingest_http_headers_and_type() {</div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;        BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot;BEGIN&quot;</span> &lt;&lt; endl);</div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;</div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">string</span> colon_space = <span class="stringliteral">&quot;: &quot;</span>;</div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; this-&gt;d_response_headers-&gt;size(); i++) {</div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;            <span class="keywordtype">string</span> header = (*d_response_headers)[i];</div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;            BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot;Processing header &quot;</span> &lt;&lt; header &lt;&lt; endl);</div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;            <span class="keywordtype">size_t</span> colon_index = header.find(colon_space);</div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;            <span class="keywordflow">if</span>(colon_index == string::npos){</div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;                BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot;Unable to locate the colon space \&quot;: \&quot; delimiter in the header &quot;</span> &lt;&lt;</div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;                                        <span class="stringliteral">&quot;string: &#39;&quot;</span> &lt;&lt; header &lt;&lt; <span class="stringliteral">&quot;&#39; SKIPPING!&quot;</span> &lt;&lt; endl);</div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;            }</div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;            <span class="keywordflow">else</span> {</div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;                <span class="keywordtype">string</span> key = <a class="code" href="../../d8/d4c/classBESUtil.html#a6c8a6c701e09aa11770a503fefe971ca">BESUtil::lowercase</a>(header.substr(0, colon_index));</div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;                <span class="keywordtype">string</span> value = header.substr(colon_index + colon_space.length());</div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;                BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot;key: &quot;</span> &lt;&lt; key &lt;&lt; <span class="stringliteral">&quot; value: &quot;</span> &lt;&lt; value &lt;&lt; endl);</div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;                (*d_http_response_headers)[key] = value;</div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;            }</div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;        }</div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;        std::map&lt;string, string&gt;::iterator it;</div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;        <span class="keywordtype">string</span> type;</div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;</div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;        <span class="comment">// Try and figure out the file type first from the</span></div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;        <span class="comment">// Content-Disposition in the http header response.</span></div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;</div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;        <span class="keywordtype">string</span> content_disp_hdr;</div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;        content_disp_hdr = get_http_response_header(<span class="stringliteral">&quot;content-disposition&quot;</span>);</div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;        <span class="keywordflow">if</span> (!content_disp_hdr.empty()) {</div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;            <span class="comment">// Content disposition exists, grab the filename</span></div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;            <span class="comment">// attribute</span></div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;            <a class="code" href="../../d3/d69/namespacehttp.html#aa74304079b551cb896e57b1537e3a320">http::get_type_from_disposition</a>(content_disp_hdr, type);</div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;            BESDEBUG(MODULE,prolog &lt;&lt; <span class="stringliteral">&quot;Evaluated content-disposition &#39;&quot;</span> &lt;&lt; content_disp_hdr &lt;&lt; <span class="stringliteral">&quot;&#39; matched type: \&quot;&quot;</span> &lt;&lt; type &lt;&lt; <span class="stringliteral">&quot;\&quot;&quot;</span> &lt;&lt; endl);</div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;        }</div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;</div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;        <span class="comment">// still haven&#39;t figured out the type. Check the content-type</span></div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;        <span class="comment">// next, translate to the BES MODULE name. It&#39;s also possible</span></div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;        <span class="comment">// that even though Content-disposition was available, we could</span></div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;        <span class="comment">// not determine the type of the file.</span></div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;        <span class="keywordtype">string</span> content_type = get_http_response_header(<span class="stringliteral">&quot;content-type&quot;</span>);</div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;        <span class="keywordflow">if</span> (type.empty() &amp;&amp; !content_type.empty()) {</div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;            http::get_type_from_content_type(content_type, type);</div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;            BESDEBUG(MODULE,prolog &lt;&lt; <span class="stringliteral">&quot;Evaluated content-type &#39;&quot;</span> &lt;&lt; content_type &lt;&lt; <span class="stringliteral">&quot;&#39; matched type \&quot;&quot;</span> &lt;&lt; type &lt;&lt; <span class="stringliteral">&quot;\&quot;&quot;</span> &lt;&lt; endl);</div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;        }</div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;</div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;        <span class="comment">// still haven&#39;t figured out the type. Now check the actual URL</span></div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;        <span class="comment">// and see if we can&#39;t match the URL to a MODULE name</span></div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;        <span class="keywordflow">if</span> (type.empty()) {</div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;            http::get_type_from_url(d_remoteResourceUrl, type);</div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;            BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot;Evaluated url &#39;&quot;</span> &lt;&lt; d_remoteResourceUrl &lt;&lt; <span class="stringliteral">&quot;&#39; matched type: \&quot;&quot;</span> &lt;&lt; type &lt;&lt; <span class="stringliteral">&quot;\&quot;&quot;</span> &lt;&lt; endl);</div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;        }</div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;</div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;        <span class="comment">// still couldn&#39;t figure it out, punt</span></div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;        <span class="keywordflow">if</span> (type.empty()) {</div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;            <span class="keywordtype">string</span> err = prolog + <span class="stringliteral">&quot;Unable to determine the type of data&quot;</span></div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;                         + <span class="stringliteral">&quot; returned from &#39;&quot;</span> + d_remoteResourceUrl + <span class="stringliteral">&quot;&#39;  Setting type to &#39;unknown&#39;&quot;</span>;</div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;            BESDEBUG(MODULE, err &lt;&lt; endl);</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;            type = <span class="stringliteral">&quot;unknown&quot;</span>;</div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;            <span class="comment">//throw BESSyntaxUserError( err, __FILE__, __LINE__ ) ;</span></div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;        }</div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;        d_type = type;</div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;        BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot;END (dataset type: &quot;</span> &lt;&lt; d_type &lt;&lt; <span class="stringliteral">&quot;)&quot;</span> &lt;&lt; endl);</div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;    }</div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;</div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;    std::string</div><div class="line"><a name="l00602"></a><span class="lineno"><a class="line" href="../../dd/d98/classhttp_1_1RemoteResource.html#a3ffbb23b98f241ef0ede82c740d9f50b">  602</a></span>&#160;    RemoteResource::get_http_response_header(<span class="keyword">const</span> std::string header_name) {</div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;        <span class="keywordtype">string</span> value(<span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;        std::map&lt;string, string&gt;::iterator it;</div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;        it = d_http_response_headers-&gt;find(<a class="code" href="../../d8/d4c/classBESUtil.html#a6c8a6c701e09aa11770a503fefe971ca">BESUtil::lowercase</a>(header_name));</div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;        <span class="keywordflow">if</span> (it != d_http_response_headers-&gt;end())</div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;            value = it-&gt;second;</div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;        <span class="keywordflow">return</span> value;</div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;    }</div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;</div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;</div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;    <span class="keywordtype">void</span> RemoteResource::filter_retrieved_resource(<span class="keyword">const</span> std::map&lt;std::string, std::string&gt; &amp;content_filters){</div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;</div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;        <span class="comment">// No filters?</span></div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;        <span class="keywordflow">if</span>(content_filters.empty()){</div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;            <span class="comment">// No problem...</span></div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;            <span class="keywordflow">return</span>;</div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;        }</div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;</div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;        <span class="comment">//  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -</span></div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;        <span class="comment">// Read the cached file into a string object</span></div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;        std::ifstream cr_istrm(d_resourceCacheFileName);</div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;        <span class="keywordflow">if</span> (!cr_istrm.is_open()) {</div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;            <span class="keywordtype">string</span> msg = <span class="stringliteral">&quot;Could not open &#39;&quot;</span> + d_resourceCacheFileName + <span class="stringliteral">&quot;&#39; to read cached response.&quot;</span>;</div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;            BESDEBUG(MODULE, prolog &lt;&lt; msg &lt;&lt; endl);</div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;            <span class="keywordflow">throw</span> <a class="code" href="../../d9/d82/classBESInternalError.html">BESInternalError</a>(msg, __FILE__, __LINE__);</div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;        }</div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;        std::stringstream buffer;</div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;        buffer &lt;&lt; cr_istrm.rdbuf();</div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;        <span class="keywordtype">string</span> resource_content(buffer.str());</div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;</div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; apair : content_filters) {</div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;            <span class="comment">//  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -</span></div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;            <span class="comment">// Replace all occurrences of the template_key with replace_value.</span></div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;            <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> replace_count = 0;</div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;            <span class="keywordtype">int</span> startIndex = 0;</div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;            <span class="keywordflow">while</span> ((startIndex = resource_content.find(apair.first)) != -1) {</div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;                resource_content.erase(startIndex, apair.first.length());</div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;                resource_content.insert(startIndex, apair.second);</div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;                replace_count++;</div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;            }</div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;            BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot;Replaced &quot;</span> &lt;&lt; replace_count &lt;&lt; <span class="stringliteral">&quot; instance(s) of template(&quot;</span> &lt;&lt;</div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;            apair.first &lt;&lt; <span class="stringliteral">&quot;) with &quot;</span> &lt;&lt; apair.second &lt;&lt; <span class="stringliteral">&quot; in cached RemoteResource&quot;</span> &lt;&lt; endl);</div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;        }</div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;</div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;</div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;        <span class="comment">//  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -</span></div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;        <span class="comment">// Replace the contents of the cached file with the modified string.</span></div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;        std::ofstream cr_ostrm(d_resourceCacheFileName);</div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;        <span class="keywordflow">if</span> (!cr_ostrm.is_open()) {</div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;            <span class="keywordtype">string</span> msg = <span class="stringliteral">&quot;Could not open &#39;&quot;</span> + d_resourceCacheFileName + <span class="stringliteral">&quot;&#39; to write modified cached response.&quot;</span>;</div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;            BESDEBUG(MODULE, prolog &lt;&lt; msg &lt;&lt; endl);</div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;            <span class="keywordflow">throw</span> <a class="code" href="../../d9/d82/classBESInternalError.html">BESInternalError</a>(msg, __FILE__, __LINE__);</div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;        }</div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;        cr_ostrm &lt;&lt; resource_content;</div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;    }</div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;</div><div class="line"><a name="l00672"></a><span class="lineno"><a class="line" href="../../dd/d98/classhttp_1_1RemoteResource.html#a0055cd645f3e5410bb86e7e97c6ee8d7">  672</a></span>&#160;    std::string RemoteResource::get_response_as_string() {</div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;</div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;        <span class="keywordflow">if</span>(!d_initialized){</div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;            stringstream msg;</div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;            msg &lt;&lt; <span class="stringliteral">&quot;ERROR. Internal state error. &quot;</span> &lt;&lt; __PRETTY_FUNCTION__ &lt;&lt; <span class="stringliteral">&quot; was called prior to retrieving resource.&quot;</span>;</div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;            BESDEBUG(MODULE, prolog &lt;&lt; msg.str() &lt;&lt; endl);</div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;            <span class="keywordflow">throw</span> <a class="code" href="../../d9/d82/classBESInternalError.html">BESInternalError</a>(msg.str(), __FILE__, __LINE__);</div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;        }</div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;        <span class="keywordtype">string</span> cache_file = getCacheFileName();</div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;        <span class="comment">//  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -</span></div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;        <span class="comment">// Set up cache file input stream.</span></div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;        std::ifstream file_istream(cache_file, std::ofstream::in);</div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;</div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;        <span class="comment">// If the cache filename is not valid, the stream will not open. Empty is not valid.</span></div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;        <span class="keywordflow">if</span>(file_istream.is_open()){</div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;            <span class="comment">// If it&#39;s open we&#39;ve got a valid input stream.</span></div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;            BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot;Using cached file: &quot;</span> &lt;&lt; cache_file &lt;&lt; endl);</div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;            std::stringstream buffer;</div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;            buffer &lt;&lt; file_istream.rdbuf();</div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;            <span class="keywordflow">return</span> buffer.str();</div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;        }</div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;        <span class="keywordflow">else</span> {</div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;            stringstream msg;</div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;            msg &lt;&lt; <span class="stringliteral">&quot;ERROR. Failed to open cache file &quot;</span> &lt;&lt; cache_file &lt;&lt; <span class="stringliteral">&quot; for reading.&quot;</span>;</div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;            BESDEBUG(MODULE, prolog &lt;&lt; msg.str() &lt;&lt; endl);</div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;            <span class="keywordflow">throw</span> <a class="code" href="../../d9/d82/classBESInternalError.html">BESInternalError</a>(msg.str(), __FILE__, __LINE__);</div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;        }</div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;</div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;    }</div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;</div><div class="line"><a name="l00709"></a><span class="lineno"><a class="line" href="../../dd/d98/classhttp_1_1RemoteResource.html#a5a0b882b53e6c278abdf78ec1de5f04f">  709</a></span>&#160;    <a class="code" href="../../db/df5/document_8h.html#ac6ea5b168e3fe8c7fa532450fc9391f7">rapidjson::Document</a> RemoteResource::get_as_json() {</div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;        <span class="keywordtype">string</span> response = get_response_as_string();</div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;        <a class="code" href="../../db/df5/document_8h.html#ac6ea5b168e3fe8c7fa532450fc9391f7">rapidjson::Document</a> d;</div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;        d.Parse(response.c_str());</div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;        <span class="keywordflow">return</span> d;</div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;    }</div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;</div><div class="line"><a name="l00719"></a><span class="lineno"><a class="line" href="../../dd/d98/classhttp_1_1RemoteResource.html#a4eabea32e536fcfd139911e2a02ad7da">  719</a></span>&#160;    vector&lt;string&gt; *RemoteResource::getResponseHeaders() {</div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;        <span class="keywordflow">if</span> (!d_initialized){</div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;            <span class="keywordflow">throw</span> <a class="code" href="../../d9/d82/classBESInternalError.html">BESInternalError</a>(prolog +<span class="stringliteral">&quot;STATE ERROR: Remote Resource Has Not Been Retrieved.&quot;</span>,__FILE__,__LINE__);</div><div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;        }</div><div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;        <span class="keywordflow">return</span> d_response_headers;</div><div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;    }</div><div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;</div><div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;</div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;<span class="preprocessor">#if 0</span></div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;    <span class="keywordtype">void</span> RemoteResource::setType(<span class="keyword">const</span> vector&lt;string&gt; *resp_hdrs) {</div><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;</div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;        BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot;BEGIN&quot;</span> &lt;&lt; endl);</div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;</div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;        <span class="keywordtype">string</span> type = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;</div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;        <span class="comment">// Try and figure out the file type first from the</span></div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;        <span class="comment">// Content-Disposition in the http header response.</span></div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;        <span class="keywordtype">string</span> disp;</div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;        <span class="keywordtype">string</span> ctype;</div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;</div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;        <span class="keywordflow">if</span> (resp_hdrs) {</div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;            vector&lt;string&gt;::const_iterator i = resp_hdrs-&gt;begin();</div><div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;            vector&lt;string&gt;::const_iterator e = resp_hdrs-&gt;end();</div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;            <span class="keywordflow">for</span> (; i != e; i++) {</div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;                <span class="keywordtype">string</span> hdr_line = (*i);</div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;</div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;                BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot;Evaluating header: &quot;</span> &lt;&lt; hdr_line &lt;&lt; endl);</div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;</div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;                hdr_line = <a class="code" href="../../d8/d4c/classBESUtil.html#a6c8a6c701e09aa11770a503fefe971ca">BESUtil::lowercase</a>(hdr_line);</div><div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;</div><div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;                <span class="keywordtype">string</span> colon_space = <span class="stringliteral">&quot;: &quot;</span>;</div><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;                <span class="keywordtype">int</span> index = hdr_line.find(colon_space);</div><div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;                <span class="keywordtype">string</span> hdr_name = hdr_line.substr(0, index);</div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;                <span class="keywordtype">string</span> hdr_value = hdr_line.substr(index + colon_space.length());</div><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;</div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;                BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot;hdr_name: &#39;&quot;</span> &lt;&lt; hdr_name &lt;&lt; <span class="stringliteral">&quot;&#39;   hdr_value: &#39;&quot;</span> &lt;&lt; hdr_value  &lt;&lt; <span class="stringliteral">&quot;&#39; &quot;</span> &lt;&lt; endl);</div><div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;</div><div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;                <span class="keywordflow">if</span> (hdr_name.find(<span class="stringliteral">&quot;content-disposition&quot;</span>) != string::npos) {</div><div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;                    <span class="comment">// Content disposition exists</span></div><div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;                    BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot;Located content-disposition header.&quot;</span> &lt;&lt; endl);</div><div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;                    disp = hdr_value;</div><div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;                }</div><div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;                <span class="keywordflow">if</span> (hdr_name.find(<span class="stringliteral">&quot;content-type&quot;</span>) != string::npos) {</div><div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;                    BESDEBUG(MODULE, prolog &lt;&lt; <span class="stringliteral">&quot;Located content-type header.&quot;</span> &lt;&lt; endl);</div><div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;                    ctype = hdr_value;</div><div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;                }</div><div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;            }</div><div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;        }</div><div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;</div><div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;        <span class="keywordflow">if</span> (!disp.empty()) {</div><div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;            <span class="comment">// Content disposition exists, grab the filename</span></div><div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;            <span class="comment">// attribute</span></div><div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;            HttpUtils::Get_type_from_disposition(disp, type);</div><div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;            BESDEBUG(MODULE,prolog &lt;&lt; <span class="stringliteral">&quot;Evaluated content-disposition &#39;&quot;</span> &lt;&lt; disp &lt;&lt; <span class="stringliteral">&quot;&#39; matched type: \&quot;&quot;</span>  &lt;&lt; type &lt;&lt; <span class="stringliteral">&quot;\&quot;&quot;</span> &lt;&lt; endl);</div><div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;        }</div><div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;</div><div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;        <span class="comment">// still haven&#39;t figured out the type. Check the content-type</span></div><div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;        <span class="comment">// next, translate to the BES MODULE name. It&#39;s also possible</span></div><div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;        <span class="comment">// that even though Content-disposition was available, we could</span></div><div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;        <span class="comment">// not determine the type of the file.</span></div><div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;        <span class="keywordflow">if</span> (type.empty() &amp;&amp; !ctype.empty()) {</div><div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;            HttpUtils::Get_type_from_content_type(ctype, type);</div><div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;            BESDEBUG(MODULE,prolog &lt;&lt; <span class="stringliteral">&quot;Evaluated content-type &#39;&quot;</span> &lt;&lt; ctype &lt;&lt; <span class="stringliteral">&quot;&#39; matched type \&quot;&quot;</span> &lt;&lt; type &lt;&lt; <span class="stringliteral">&quot;\&quot;&quot;</span> &lt;&lt; endl);</div><div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;        }</div><div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;</div><div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;        <span class="comment">// still haven&#39;t figured out the type. Now check the actual URL</span></div><div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;        <span class="comment">// and see if we can&#39;t match the URL to a MODULE name</span></div><div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;        <span class="keywordflow">if</span> (type.empty()) {</div><div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;            HttpUtils::Get_type_from_url(d_remoteResourceUrl, type);</div><div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;            BESDEBUG(MODULE,prolog &lt;&lt; <span class="stringliteral">&quot;Evaluated url &#39;&quot;</span> &lt;&lt; d_remoteResourceUrl &lt;&lt; <span class="stringliteral">&quot;&#39; matched type: \&quot;&quot;</span> &lt;&lt; type &lt;&lt; <span class="stringliteral">&quot;\&quot;&quot;</span> &lt;&lt; endl);</div><div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;        }</div><div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;</div><div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;        <span class="comment">// still couldn&#39;t figure it out, punt</span></div><div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;        <span class="keywordflow">if</span> (type.empty()) {</div><div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;            <span class="keywordtype">string</span> err = prolog + <span class="stringliteral">&quot;Unable to determine the type of data&quot;</span></div><div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;                         + <span class="stringliteral">&quot; returned from &#39;&quot;</span> + d_remoteResourceUrl + <span class="stringliteral">&quot;&#39;  Setting type to &#39;unknown&#39;&quot;</span>;</div><div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;            BESDEBUG(MODULE, err &lt;&lt; endl);</div><div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;            type = <span class="stringliteral">&quot;unknown&quot;</span>;</div><div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;            <span class="comment">//throw BESSyntaxUserError( err, __FILE__, __LINE__ ) ;</span></div><div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;        }</div><div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;</div><div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;        <span class="comment">// @TODO CACHE THE DATA TYPE OR THE HTTP HEADERS SO WHEN WE ARE RETRIEVING THE CACHED OBJECT WE CAN GET THE CORRECT TYPE</span></div><div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;</div><div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;        d_type = type;</div><div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;    }</div><div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;</div><div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;</div><div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;} <span class="comment">//  namespace http</span></div><div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;</div><div class="ttc" id="classBESFileLockingCache_html_a1a70fdaa70577bd545eb842015bb85b8"><div class="ttname"><a href="../../dd/d75/classBESFileLockingCache.html#a1a70fdaa70577bd545eb842015bb85b8">BESFileLockingCache::unlock_cache</a></div><div class="ttdeci">virtual void unlock_cache()</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d12/BESFileLockingCache_8cc_source.html#l00678">BESFileLockingCache.cc:678</a></div></div>
<div class="ttc" id="classBESNotFoundError_html"><div class="ttname"><a href="../../dc/d1a/classBESNotFoundError.html">BESNotFoundError</a></div><div class="ttdoc">error thrown if the resource requested cannot be found </div><div class="ttdef"><b>Definition:</b> <a href="../../de/dc6/BESNotFoundError_8h_source.html#l00040">BESNotFoundError.h:40</a></div></div>
<div class="ttc" id="classBESInternalError_html"><div class="ttname"><a href="../../d9/d82/classBESInternalError.html">BESInternalError</a></div><div class="ttdoc">exception thrown if internal error encountered </div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d8b/BESInternalError_8h_source.html#l00043">BESInternalError.h:43</a></div></div>
<div class="ttc" id="classBESFileLockingCache_html_afd7797d9ecb3d4daf0efc9e4ca0a36ce"><div class="ttname"><a href="../../dd/d75/classBESFileLockingCache.html#afd7797d9ecb3d4daf0efc9e4ca0a36ce">BESFileLockingCache::update_and_purge</a></div><div class="ttdeci">virtual void update_and_purge(const std::string &amp;new_file)</div><div class="ttdoc">Purge files from the cache. </div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d12/BESFileLockingCache_8cc_source.html#l00931">BESFileLockingCache.cc:931</a></div></div>
<div class="ttc" id="classBESFileLockingCache_html_a5bf293b1c39103e9d6d0fcb88edabe6a"><div class="ttname"><a href="../../dd/d75/classBESFileLockingCache.html#a5bf293b1c39103e9d6d0fcb88edabe6a">BESFileLockingCache::update_cache_info</a></div><div class="ttdeci">virtual unsigned long long update_cache_info(const std::string &amp;target)</div><div class="ttdoc">Update the cache info file to include &amp;#39;target&amp;#39;. </div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d12/BESFileLockingCache_8cc_source.html#l00729">BESFileLockingCache.cc:729</a></div></div>
<div class="ttc" id="classBESError_html_ab89722014819ca821667f4feb0f4eda0"><div class="ttname"><a href="../../d7/dbd/classBESError.html#ab89722014819ca821667f4feb0f4eda0">BESError::get_message</a></div><div class="ttdeci">virtual std::string get_message()</div><div class="ttdoc">get the error message for this exception </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/dcf/BESError_8h_source.html#l00099">BESError.h:99</a></div></div>
<div class="ttc" id="classhttp_1_1HttpCache_html"><div class="ttname"><a href="../../d1/d11/classhttp_1_1HttpCache.html">http::HttpCache</a></div><div class="ttdoc">A cache for content accessed via HTTP. </div><div class="ttdef"><b>Definition:</b> <a href="../../d1/dbe/HttpCache_8h_source.html#l00054">HttpCache.h:54</a></div></div>
<div class="ttc" id="namespacestd_html"><div class="ttname"><a href="../../d8/dcc/namespacestd.html">std</a></div><div class="ttdoc">STL namespace. </div></div>
<div class="ttc" id="classBESFileLockingCache_html_a5777955384b133127a2518f44ea28444"><div class="ttname"><a href="../../dd/d75/classBESFileLockingCache.html#a5777955384b133127a2518f44ea28444">BESFileLockingCache::unlock_and_close</a></div><div class="ttdeci">virtual void unlock_and_close(const std::string &amp;target)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d12/BESFileLockingCache_8cc_source.html#l00705">BESFileLockingCache.cc:705</a></div></div>
<div class="ttc" id="namespacehttp_html"><div class="ttname"><a href="../../d3/d69/namespacehttp.html">http</a></div><div class="ttdoc">utility class for the HTTP catalog module </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/dd5/EffectiveUrl_8cc_source.html#l00058">EffectiveUrl.cc:58</a></div></div>
<div class="ttc" id="classTheBESKeys_html_a18b1aa0f0cee5dd5cf787a14fd1e8951"><div class="ttname"><a href="../../d5/d64/classTheBESKeys.html#a18b1aa0f0cee5dd5cf787a14fd1e8951">TheBESKeys::get_value</a></div><div class="ttdeci">void get_value(const std::string &amp;s, std::string &amp;val, bool &amp;found)</div><div class="ttdoc">Retrieve the value of a given key, if set. </div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d8a/TheBESKeys_8cc_source.html#l00339">TheBESKeys.cc:339</a></div></div>
<div class="ttc" id="classhttp_1_1HttpCache_html_a20f68e852206c0ac0c0c9c2802f5bf53"><div class="ttname"><a href="../../d1/d11/classhttp_1_1HttpCache.html#a20f68e852206c0ac0c0c9c2802f5bf53">http::HttpCache::get_cache_file_name</a></div><div class="ttdeci">virtual std::string get_cache_file_name(const std::string &amp;uid, const std::string &amp;src, bool mangle=true)</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/d43/HttpCache_8cc_source.html#l00266">HttpCache.cc:266</a></div></div>
<div class="ttc" id="classBESError_html"><div class="ttname"><a href="../../d7/dbd/classBESError.html">BESError</a></div><div class="ttdoc">Abstract exception class for the BES with basic string message. </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/dcf/BESError_8h_source.html#l00058">BESError.h:58</a></div></div>
<div class="ttc" id="classTheBESKeys_html_a2434be88f175d43ee8a6dd69754496a6"><div class="ttname"><a href="../../d5/d64/classTheBESKeys.html#a2434be88f175d43ee8a6dd69754496a6">TheBESKeys::TheKeys</a></div><div class="ttdeci">static TheBESKeys * TheKeys()</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d8a/TheBESKeys_8cc_source.html#l00071">TheBESKeys.cc:71</a></div></div>
<div class="ttc" id="classBESFileLockingCache_html_a9e12d93d7fe5f5f03190f92362773050"><div class="ttname"><a href="../../dd/d75/classBESFileLockingCache.html#a9e12d93d7fe5f5f03190f92362773050">BESFileLockingCache::create_and_lock</a></div><div class="ttdeci">virtual bool create_and_lock(const std::string &amp;target, int &amp;fd)</div><div class="ttdoc">Create a file in the cache and lock it for write access. </div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d12/BESFileLockingCache_8cc_source.html#l00592">BESFileLockingCache.cc:592</a></div></div>
<div class="ttc" id="document_8h_html"><div class="ttname"><a href="../../db/df5/document_8h.html">document.h</a></div></div>
<div class="ttc" id="document_8h_html_ac6ea5b168e3fe8c7fa532450fc9391f7"><div class="ttname"><a href="../../db/df5/document_8h.html#ac6ea5b168e3fe8c7fa532450fc9391f7">Document</a></div><div class="ttdeci">GenericDocument&lt; UTF8&lt;&gt; &gt; Document</div><div class="ttdoc">GenericDocument with UTF8 encoding. </div><div class="ttdef"><b>Definition:</b> <a href="../../db/df5/document_8h_source.html#l02585">document.h:2585</a></div></div>
<div class="ttc" id="classBESUtil_html_a6fe40e13784e613b86c7cc13dfafbda0"><div class="ttname"><a href="../../d8/d4c/classBESUtil.html#a6fe40e13784e613b86c7cc13dfafbda0">BESUtil::pathConcat</a></div><div class="ttdeci">static std::string pathConcat(const std::string &amp;firstPart, const std::string &amp;secondPart, char separator='/')</div><div class="ttdoc">Concatenate path fragments making sure that they are separated by a single &amp;#39;/&amp;#39; character. </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d60/BESUtil_8cc_source.html#l00772">BESUtil.cc:772</a></div></div>
<div class="ttc" id="classBESFileLockingCache_html_a441ebd5ab55997464c99acdb68c5b8d2"><div class="ttname"><a href="../../dd/d75/classBESFileLockingCache.html#a441ebd5ab55997464c99acdb68c5b8d2">BESFileLockingCache::cache_too_big</a></div><div class="ttdeci">virtual bool cache_too_big(unsigned long long current_size) const </div><div class="ttdoc">look at the cache size; is it too large? Look at the cache size and see if it is too big...</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d12/BESFileLockingCache_8cc_source.html#l00772">BESFileLockingCache.cc:772</a></div></div>
<div class="ttc" id="classBESStopWatch_html"><div class="ttname"><a href="../../dd/d47/classBESStopWatch.html">BESStopWatch</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d0/dac/BESStopWatch_8h_source.html#l00055">BESStopWatch.h:55</a></div></div>
<div class="ttc" id="classBESUtil_html_a6c8a6c701e09aa11770a503fefe971ca"><div class="ttname"><a href="../../d8/d4c/classBESUtil.html#a6c8a6c701e09aa11770a503fefe971ca">BESUtil::lowercase</a></div><div class="ttdeci">static std::string lowercase(const std::string &amp;s)</div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d60/BESUtil_8cc_source.html#l00200">BESUtil.cc:200</a></div></div>
<div class="ttc" id="classBESUtil_html_a2576ba5d2f9e4ad4fa6d413fe9785d27"><div class="ttname"><a href="../../d8/d4c/classBESUtil.html#a2576ba5d2f9e4ad4fa6d413fe9785d27">BESUtil::endsWith</a></div><div class="ttdeci">static bool endsWith(std::string const &amp;fullString, std::string const &amp;ending)</div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d60/BESUtil_8cc_source.html#l00942">BESUtil.cc:942</a></div></div>
<div class="ttc" id="namespacehttp_html_aa74304079b551cb896e57b1537e3a320"><div class="ttname"><a href="../../d3/d69/namespacehttp.html#aa74304079b551cb896e57b1537e3a320">http::get_type_from_disposition</a></div><div class="ttdeci">void get_type_from_disposition(const string &amp;disp, string &amp;type)</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d26/HttpUtils_8cc_source.html#l00109">HttpUtils.cc:109</a></div></div>
<div class="ttc" id="classBESError_html_ab6f11913d45356a6ad65aac7eefe720d"><div class="ttname"><a href="../../d7/dbd/classBESError.html#ab6f11913d45356a6ad65aac7eefe720d">BESError::get_file</a></div><div class="ttdeci">virtual std::string get_file()</div><div class="ttdoc">get the file name where the exception was thrown </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/dcf/BESError_8h_source.html#l00107">BESError.h:107</a></div></div>
<div class="ttc" id="classBESFileLockingCache_html_aa75f998ba8f95f88ba25624ff300f3ec"><div class="ttname"><a href="../../dd/d75/classBESFileLockingCache.html#aa75f998ba8f95f88ba25624ff300f3ec">BESFileLockingCache::exclusive_to_shared_lock</a></div><div class="ttdeci">virtual void exclusive_to_shared_lock(int fd)</div><div class="ttdoc">Transfer from an exclusive lock to a shared lock. </div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d12/BESFileLockingCache_8cc_source.html#l00622">BESFileLockingCache.cc:622</a></div></div>
<div class="ttc" id="classBESError_html_a9c2743b847d8d3339d894aef27c4db16"><div class="ttname"><a href="../../d7/dbd/classBESError.html#a9c2743b847d8d3339d894aef27c4db16">BESError::get_bes_error_type</a></div><div class="ttdeci">virtual int get_bes_error_type()</div><div class="ttdoc">Return the return code for this error class. </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/dcf/BESError_8h_source.html#l00143">BESError.h:143</a></div></div>
<div class="ttc" id="classBESDebug_html_a82246dd035105f7af39a296ddcc51bab"><div class="ttname"><a href="../../d1/ded/classBESDebug.html#a82246dd035105f7af39a296ddcc51bab">BESDebug::IsSet</a></div><div class="ttdeci">static bool IsSet(const std::string &amp;flagName)</div><div class="ttdoc">see if the debug context flagName is set to true </div><div class="ttdef"><b>Definition:</b> <a href="../../d4/da3/BESDebug_8h_source.html#l00168">BESDebug.h:168</a></div></div>
<div class="ttc" id="classBESStopWatch_html_a9d693f705d403a80937475820fef7e76"><div class="ttname"><a href="../../dd/d47/classBESStopWatch.html#a9d693f705d403a80937475820fef7e76">BESStopWatch::start</a></div><div class="ttdeci">virtual bool start(std::string name)</div><div class="ttdef"><b>Definition:</b> <a href="../../d0/dcf/BESStopWatch_8cc_source.html#l00067">BESStopWatch.cc:67</a></div></div>
<div class="ttc" id="classBESFileLockingCache_html_aa9ae66ea9b3931933f3f4e02562a8d04"><div class="ttname"><a href="../../dd/d75/classBESFileLockingCache.html#aa9ae66ea9b3931933f3f4e02562a8d04">BESFileLockingCache::get_read_lock</a></div><div class="ttdeci">virtual bool get_read_lock(const std::string &amp;target, int &amp;fd)</div><div class="ttdoc">Get a read-only lock on the file if it exists. </div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d12/BESFileLockingCache_8cc_source.html#l00537">BESFileLockingCache.cc:537</a></div></div>
<div class="ttc" id="classBESError_html_aa078d566600c190d1ec900292f24dd87"><div class="ttname"><a href="../../d7/dbd/classBESError.html#aa078d566600c190d1ec900292f24dd87">BESError::get_line</a></div><div class="ttdeci">virtual int get_line()</div><div class="ttdoc">get the line number where the exception was thrown </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/dcf/BESError_8h_source.html#l00115">BESError.h:115</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../dir_de5b03c9e251d763a573c2ccd217de59.html">http</a></li><li class="navelem"><b>RemoteResource.cc</b></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.11 </li>
  </ul>
</div>
</body>
</html>
